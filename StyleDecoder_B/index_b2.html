<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>â™¡å®¤å…§ç©ºé–“åå¥½é¸æ“‡ç³»çµ±â™¡</title>
  <h1 style="text-align: center;"></h1>
  <header>
    <!-- <h1>â™¡å®¤å…§ç©ºé–“åå¥½é¸æ“‡ç³»çµ±â™¡</h1> -->
  </header>
  <!-- <div id="login-container" style="text-align: center;">
    <p>è«‹è¼¸å…¥æš±ç¨±é€²å…¥</p>
    <p>è«‹å‹™å¿…è¼¸å…¥èˆ‡ä¸Šä¸€å€‹ç³»çµ±ç›¸åŒçš„æš±ç¨±ï¼Œä»¥åˆ©è³‡è¨Šçš„æ ¸å°ï¼Œéå¸¸æ„Ÿè¬æ‚¨çš„é…åˆ~</p>
    <input type="text" id="name-input" placeholder="è¼¸å…¥æš±ç¨±"><br><br> 
    <button onclick="startTest()">ç¢ºèª</button>
    <p id="error-message" style="color:red;"></p>
  </div> -->

  <style>

header {
  display: none;
}

    body {
      font-family: 'Noto Sans TC', sans-serif;
      padding: 40px;
      line-height: 1.6;
      background: #fafafa;
      color: #333;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
      padding-bottom: 4px;
      text-align: center;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    #colorDesc {
      grid-template-columns: repeat(4, 1fr);
    }

    .image-grid img {
      width: 100%;
      border: 8px solid transparent;
      cursor: pointer;
      border-radius: 8px;
      transition: border 0.2s ease;
    }

    .image-grid img:hover {
      border-color: #aaa;
    }

    .image-grid img.selected {
      border-color: #ff9b21;
    }

    .hidden {
      display: none;
    }

    #resultImage {
    max-width: 90vw;
    width: 800px;
    margin-top: 20px;
    display: block;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

    button {
      display: block;
      width: 100%;
      max-width: 320px;
      margin: 12px auto;
      background-color: #e9d04f;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #c9aa0f;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* æ•´å€‹ summary æ–‡å­—ç½®ä¸­ */
    #summary {
      text-align: center;
    }

    /* åœ–ç‰‡å¡Šè¦æ°´å¹³ç½®ä¸­ï¼ˆblock + auto marginï¼‰ */
    #summary img {
      display: block;
      margin: 20px auto 0;
    }

    /* å¦‚æœä¹‹å¾Œæœ‰æŒ‰éˆ•ï¼Œä¹Ÿæƒ³è¦ç½®ä¸­ï¼š */
    #summary .btn-group {
      justify-content: center;
    }

    /* æ‰‹æ©Ÿç‰ˆï¼šå–®æ¬„é¡¯ç¤º */
    @media only screen and (max-width: 768px) {
      .image-grid {
        /* ä¸€è¡Œåªé¡¯ç¤º 1 å¼µ */
        grid-template-columns: 1fr !important;
      }
      /* å¦‚æœä½ å¸Œæœ›æŒ‰éˆ•ä¹Ÿèƒ½æ’æ»¿æ•´è¡Œ */
      button {
        max-width: none;
        margin: 12px 0; /* å·¦å³ 0 */
      }
      .image-grid img {
        width: auto;
        max-width: 60%;
        margin: 0 auto;
      }
    }

  </style>
</head>
  <!-- éš±è—çš„ iframeï¼ˆç”¨ä¾†æ¥æ”¶ form å›æ‡‰ï¼‰-->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <!-- éš±è—çš„ Google Formï¼Œæ³¨æ„é€™è£¡è¦æœ‰ <form> é–‹é ­ -->
<form id="hiddenGoogleForm"
    action="https://docs.google.com/forms/d/e/1FAIpQLSfK3gPZdCRmp-vlIMZf0OL6MkQIkCjKAGsvNugN9SdRrtVuDg/formResponse"
    method="POST"
    target="hidden_iframe"
    style="display:none;">
    <input type="text" name="entry.2070893556" id="hiddenName" />
    <input type="text" name="entry.1679096955" id="hiddenResult" />
</form>
</form>
<body>
<div id="selector-container" class="hidden">
  <h2 id="layoutTitle">
  <span style="font-size: 30px;">è«‹é¸æ“‡4å¼µä½ å–œæ­¡çš„"ç©ºé–“æ„Ÿ"<br></span>
  <span style="font-size: 18px;">ğŸ“Œ è«‹ç­‰æ‰€æœ‰åœ–ç‰‡çš†è¼‰å…¥å®Œæˆå¾Œï¼Œå†é€²è¡Œé¸æ“‡ã€‚</span>
  </h2>
  <div id="layout" class="image-grid"></div>
  
  <h2 id="atmosphereTitle" class="hidden">
  <span style="font-size: 30px;">è«‹é¸æ“‡4å¼µä½ å–œæ­¡çš„"é€ å‹æ„Ÿ" <br></span>
  <span style="font-size: 18px;">ğŸ“Œ è«‹ç­‰æ‰€æœ‰åœ–ç‰‡çš†è¼‰å…¥å®Œæˆå¾Œï¼Œå†é€²è¡Œé¸æ“‡ã€‚</span></h2>
  <div id="atmosphere" class="image-grid hidden"></div>

  <h2 id="colorDescTitle" class="hidden">
  <span style="font-size: 30px;">è«‹é¸æ“‡1å¼µä½ "æœ€"å–œæ­¡çš„<br></span>
  <span style="font-size: 18px;">ğŸ“Œ è«‹ç­‰æ‰€æœ‰åœ–ç‰‡çš†è¼‰å…¥å®Œæˆå¾Œï¼Œå†é€²è¡Œé¸æ“‡ã€‚</span></h2>
  <div id="colorDesc" class="image-grid hidden"></div>

  <div id="summary" class="hidden">
    <h2>ä¸‹åœ–ç‚ºæ‚¨çš„åå¥½åˆ†æçµæœ</h2>
    <p>å»ºè­°æ‚¨æˆªåœ–ä¿å­˜å”·~</p>
    <p>
      æ„Ÿè¬æ‚¨çš„æ¸¬è©¦ï¼Œè«‹åˆ°é€™é‚Šå¹«æˆ‘
      <a href="#" onclick="goToBQuestionnaire()">å¡«å¯«å•å·</a>
      ï¼Œéå¸¸æ„Ÿè¬ï¼(å°å°æé†’~å•å·å¡«å¯«å®Œç•¢åœ¨æ„Ÿè¬é é¢è«‹å¹«æˆ‘æ¥è‘—é»é¸ç¶²å€é€²å…¥ç¬¬äºŒå€‹ç³»çµ±å”·~)
    </p>
    <!-- <p id="textResult"></p> -->
    <img id="resultImage" src="">
</div>

<script>

// å¾ç¶²å€æŠ“å– nicknameï¼ˆå¦‚æœæœ‰ï¼‰
function getNicknameFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("nickname") || "";
}

let userName = '';

window.addEventListener("DOMContentLoaded", () => {
  const fromURL = getNicknameFromURL();
  if (fromURL) {
    document.getElementById('name-input').value = fromURL;
  }
});

function startTest() {
  let name = document.getElementById('name-input').value.trim();
  const error = document.getElementById('error-message');

  if (!name) {
    name = getNicknameFromURL();
    if (!name) {
      error.textContent = 'è«‹è¼¸å…¥æš±ç¨±';
      return;
    }
    document.getElementById('name-input').value = name;
  }

  // å­˜èµ·ä¾†çµ¦å¾Œé¢é€è¡¨å–®ã€è·³ä¸‹ä¸€ä»½å•å·ç”¨
  userName = name;

  // --------- é€™è£¡åŠ ï¼šæŠŠæš±ç¨±å¡åˆ°ç¶²å€ ---------
  const newUrl = window.location.pathname + '?nickname=' + encodeURIComponent(name);
  history.replaceState(null, '', newUrl);
  // ------------------------------------------

  // éš±è—è¼¸å…¥å€ã€é¡¯ç¤ºé¸åœ–å€
  document.getElementById('login-container').style.display = 'none';
  document.getElementById('selector-container').classList.remove('hidden');
}

  const config = {
    layout: {
      options: [
        { zh: 'å¯†é›†', en: 'dense' },
        { zh: 'æ¨™æº–', en: 'standard' },
        { zh: 'åˆ†æ•£', en: 'loose' }
      ],
      count: 5,
      folder: () => './pic/'
    },
    atmosphere: {
      options: [
        { zh: 'è£é£¾è¤‡é›œ', en: 'ornate' },
        { zh: 'è£é£¾ç°¡å–®', en: 'plain' },
        { zh: 'å¼§åº¦', en: 'arc-min' },
        { zh: 'ç·šæ¢æ–¹æ­£', en: 'rect' },
        { zh: 'ç„¡æ˜é¡¯è¼ªå»“', en: 'blur' }
      ],
      count: 3,
      folder: () => './pic/'
    },
    colorDesc: {
      options: [
        { zh: 'å†·ç¡¬ Ã— å–®ä¸€è‰²', en: 'hard_mono' },
        { zh: 'å†·ç¡¬ Ã— é›™è‰²', en: 'hard_duo' },
        { zh: 'å†·ç¡¬ Ã— ä½å°æ¯”å¤šè‰²', en: 'hard_lowmulti' },
        { zh: 'å†·ç¡¬ Ã— é«˜å°æ¯”å¤šè‰²', en: 'hard_highmulti' },
        { zh: 'ä¸­å’Œ Ã— å–®ä¸€è‰²', en: 'neutral_mono' },
        { zh: 'ä¸­å’Œ Ã— é›™è‰²', en: 'neutral_duo' },
        { zh: 'ä¸­å’Œ Ã— ä½å°æ¯”å¤šè‰²', en: 'neutral_lowmulti' },
        { zh: 'ä¸­å’Œ Ã— é«˜å°æ¯”å¤šè‰²', en: 'neutral_highmulti' },
        { zh: 'æŸ”å’Œ Ã— å–®ä¸€è‰²', en: 'soft_mono' },
        { zh: 'æŸ”å’Œ Ã— é›™è‰²', en: 'soft_duo' },
        { zh: 'æŸ”å’Œ Ã— ä½å°æ¯”å¤šè‰²', en: 'soft_lowmulti' },
        { zh: 'æŸ”å’Œ Ã— é«˜å°æ¯”å¤šè‰²', en: 'soft_highmulti' }
      ],
      count: 1,
      folder: () => './pic/'
    }
  };
  
  const labelMap = {
    layout: { dense: 'å¯†é›†', standard: 'æ¨™æº–', loose: 'åˆ†æ•£' },
    atmosphere: {
      ornate: 'è£é£¾è¤‡é›œ',
      plain: 'è£é£¾ç°¡å–®',
      'arc-min': 'å¼§åº¦ç·šæ¢',
      rect: 'ç·šæ¢æ–¹æ­£',
      blur: 'ç„¡æ˜é¡¯è¼ªå»“'
    },
    colorDescMaterial: { hard: 'å†·ç¡¬', neutral: 'ä¸­æ€§', soft: 'æŸ”å’Œ' },
    colorDescColor: {
      mono: 'å–®ä¸€è‰²',
      duo: 'é›™è‰²',
      lowmulti: 'ä½å°æ¯”å¤šè‰²',
      highmulti: 'é«˜å°æ¯”å¤šè‰²'
    }
  };
  
  let selections = { layout: [], atmosphere: [], colorDesc: null };
  let resolvedCategory = { layout: null, atmosphere: null };
  let tiedSelections = {};
  
  function createImage(src, group, layer, container) {
    const img = document.createElement('img');
    img.src = src;
    img.dataset.group = group;
    img.addEventListener('click', () => {
      if (layer === 'colorDesc') {
        if (selections[layer]) selections[layer].classList.remove('selected');
        img.classList.add('selected');
        selections[layer] = img;
      } else {
        if (img.classList.contains('selected')) {
          img.classList.remove('selected');
          selections[layer] = selections[layer].filter(i => i !== img);
        } else if (selections[layer].length < 4) {
          img.classList.add('selected');
          selections[layer].push(img);
        }
      }
    });
    container.appendChild(img);
  }
  
  function resolveTie(images, layerName, nextLayerName) {
    tiedSelections[layerName] = images.slice();
    const container = document.getElementById(layerName);
    const titleEl = document.getElementById(layerName + 'Title');
    container.innerHTML = '';
    titleEl.textContent = 'ä½ é¸æ“‡çš„åœ–ç‰‡ä¸­æœ‰å¤šç¨®çµæœä¸¦åˆ—ï¼Œè«‹å¾ä¸‹åˆ—åœ–ç‰‡ä¸­é¸å‡ºä½ æœ€å–œæ­¡çš„ä¸€å¼µï¼š';
    container.classList.remove('hidden');
    titleEl.classList.remove('hidden');
    let selectedImg = null;
    images.forEach(img => {
      const clone = img.cloneNode(true);
      clone.classList.remove('selected');
      clone.addEventListener('click', () => {
        if (selectedImg) selectedImg.classList.remove('selected');
        clone.classList.add('selected');
        selectedImg = clone;
      });
      container.appendChild(clone);
    });
    const confirmWrapper = document.createElement('div');
    confirmWrapper.style.textAlign = 'center';
    confirmWrapper.style.marginTop = '30px';
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'ç¢ºå®š';
    confirmBtn.style.width = '100%';
    confirmBtn.style.maxWidth = '320px';
    confirmBtn.onclick = () => {
      if (!selectedImg) {
        alert('è«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡å¾Œå†æŒ‰ç¢ºå®šï¼');
        return;
      }
      resolvedCategory[layerName] = selectedImg.dataset.group;
      selections[layerName] = [selectedImg];
      confirmWrapper.remove();
      container.classList.add('hidden');
      titleEl.classList.add('hidden');
      document.getElementById(nextLayerName + 'Title').classList.remove('hidden');
      document.getElementById(nextLayerName).classList.remove('hidden');
    };
    confirmWrapper.appendChild(confirmBtn);
    container.insertAdjacentElement('afterend', confirmWrapper);
  }
  
  function loadLayer(layerName, nextLayerName) {
    const configLayer = config[layerName];
    const container = document.getElementById(layerName);
    container.innerHTML = '';
    for (const option of configLayer.options) {
      for (let i = 1; i <= configLayer.count; i++) {
        const fileName = layerName === 'colorDesc'
          ? option.en + '.png'
          : option.en + '-' + i + '.png';
        const src = (layerName === 'colorDesc'
          ? configLayer.folder()
          : configLayer.folder(option.en)) + fileName;
        createImage(src, option.en, layerName, container);
      }
    }
    const btnContainer = document.createElement('div');
    btnContainer.className = 'btn-group';
    if (layerName !== 'layout') {
      const backBtn = document.createElement('button');
      backBtn.textContent = 'ä¸Šä¸€æ­¥';
      backBtn.onclick = () => {
        container.classList.add('hidden');
        document.getElementById(layerName + 'Title').classList.add('hidden');
        const prevLayer = layerName === 'atmosphere' ? 'layout' : 'atmosphere';
        if (tiedSelections[prevLayer]) {
          resolveTie(tiedSelections[prevLayer], prevLayer, layerName);
        } else {
          document.getElementById(prevLayer).classList.remove('hidden');
          document.getElementById(prevLayer + 'Title').classList.remove('hidden');
        }
      };
      btnContainer.appendChild(backBtn);
    }
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
    nextBtn.onclick = () => {
      const selectedCount = layerName === 'colorDesc'
        ? (selections[layerName] ? 1 : 0)
        : selections[layerName].length;
      const requiredCount = layerName === 'colorDesc' ? 1 : 4;
      if (selectedCount < requiredCount) {
        alert('è«‹é¸æ“‡ ' + requiredCount + ' å¼µåœ–ç‰‡å¾Œå†é€²è¡Œä¸‹ä¸€æ­¥ï¼');
        return;
      }
      if (selectedCount > requiredCount) {
        alert('åªèƒ½é¸æ“‡ ' + requiredCount + ' å¼µåœ–ç‰‡ï¼Œè«‹å–æ¶ˆå¤šé¤˜çš„é¸æ“‡ã€‚');
        return;
      }
      if (layerName !== 'colorDesc') {
        const counts = {};
        selections[layerName].forEach(img => {
          const key = img.dataset.group;
          counts[key] = (counts[key] || 0) + 1;
        });
        const maxCount = Math.max.apply(null, Object.values(counts));
        const topCats = Object.keys(counts).filter(k => counts[k] === maxCount);
        if (topCats.length > 1) {
          const tied = selections[layerName].filter(img =>
            topCats.includes(img.dataset.group)
          );
          return resolveTie(tied, layerName, nextLayerName);
        }
        resolvedCategory[layerName] = topCats[0];
      }
      container.classList.add('hidden');
      document.getElementById(layerName + 'Title').classList.add('hidden');
      if (layerName === 'colorDesc') {
        showResult();
      } else {
        document.getElementById(nextLayerName + 'Title').classList.remove('hidden');
        document.getElementById(nextLayerName).classList.remove('hidden');
      }
    };
    btnContainer.appendChild(nextBtn);
    container.appendChild(btnContainer);
  }
  
  function showResult() {
    if (!selections.colorDesc) {
      alert('è«‹é¸æ“‡ä¸€å¼µè‰²å½©åœ–ç‰‡ï¼');
      return;
    }
    const topL = resolvedCategory.layout;
    const topA = resolvedCategory.atmosphere;
    const color = selections.colorDesc.dataset.group;
    const parts = color.split('_'); // parts[0] = material, parts[1] = color
    document.getElementById('summary').classList.remove('hidden');
    // document.getElementById('textResult').innerHTML =
    //   'ç©ºé–“å¸ƒå±€ï¼š' + labelMap.layout[topL] + '<br>' +
    //   'ç©ºé–“æ°›åœç‰¹å¾µï¼š' + labelMap.atmosphere[topA] + '<br>' +
    //   'æè³ªï¼š' + labelMap.colorDescMaterial[parts[0]] + '<br>' +
    //   'é¡è‰²ï¼š' + labelMap.colorDescColor[parts[1]];
      document.getElementById('resultImage').src =
      './final/' + topL + '_' + topA + '_' + parts[1] + '_' + parts[0] + '.png';
        
      // çµ„æˆè¦é€çš„å­—ä¸²
      const summaryString =
        'ç©ºé–“å¸ƒå±€ï¼š' + labelMap.layout[topL] +
        '; ç©ºé–“æ°›åœï¼š' + labelMap.atmosphere[topA] +
        '; æè³ªï¼š' + labelMap.colorDescMaterial[parts[0]] +
        '; é¡è‰²ï¼š' + labelMap.colorDescColor[parts[1]];

      // å¡é€²éš±è—è¡¨å–®
      document.getElementById('hiddenName').value   = userName;
      document.getElementById('hiddenResult').value = summaryString;

      // é€å‡ºè¡¨å–®
      document.getElementById('hiddenGoogleForm').submit();
  }
  
  loadLayer('layout', 'atmosphere');
  loadLayer('atmosphere', 'colorDesc');
  loadLayer('colorDesc', 'summary');

  function submitToGoogleForm(name, selectionString) {
  const formURL = 'https://docs.google.com/forms/d/e/1FAIpQLSfK3gPZdCRmp-vlIMZf0OL6MkQIkCjKAGsvNugN9SdRrtVuDg/formResponse';
  const formData = new FormData();
  formData.append('entry.2070893556', name);              // æš±ç¨±
  formData.append('entry.1679096955', selectionString);   // çµæœ

  fetch(formURL, {
    method: 'POST',
    mode: 'no-cors',
    body: formData
  }).then(() => {
    console.log('âœ… è¡¨å–®é€å‡ºæˆåŠŸ');
  }).catch(err => {
    console.error('âŒ è¡¨å–®é€å‡ºå¤±æ•—', err);
  });
}
//æ”¾å•å·
function goToBQuestionnaire() {
  const nickname = userName || getNicknameFromURL();
  console.log("âœ… goToBQuestionnaire å–å¾—æš±ç¨±ï¼š", nickname);  // â¬…ï¸ æ–°å¢
  const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSe5a1FdXzium8nbfZ1pDS1ZHg8DrqvTWvaHrj4t2auACXivgg/viewform?usp=pp_url&entry.258648634=" + encodeURIComponent(nickname);
  window.location.href = formUrl;
}

window.addEventListener("DOMContentLoaded", () => {
  userName = getNicknameFromURL(); // ç›´æ¥å¾ç¶²å€å–å¾— nickname
  document.getElementById('selector-container').style.display = 'block';
  renderOptions(0);
});
  </script>
  </div>
</body>
</html>