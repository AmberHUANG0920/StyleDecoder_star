<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>â™¡â™¡å®¤å…§ç©ºé–“åå¥½é¸æ“‡ç³»çµ±â™¡â™¡</title>

  <link rel="stylesheet" href="style.css">
  <style>
    header {
      background-color: #f0e68c;
      color: #333;
      padding: 24px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .img-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      backdrop-filter: blur(8px);
      background-color: rgba(0, 0, 0, 0.2);
      z-index: 999;
      pointer-events: none;
    }
    .img-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transition: transform 0.3s ease;
      z-index: 1000;
      border-radius: 6px;
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    button {
      display: block;
      width: 100%;
      max-width: 320px;
      margin: 12px auto;
      background-color: #e9d04f;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
  </style>
</head>
<!-- éš±è—çš„ iframeï¼ˆç”¨ä¾†æ¥æ”¶ form å›æ‡‰ï¼‰-->
<iframe name="hidden_iframe" style="display:none;"></iframe>

<!-- éš±è—çš„ Google Formï¼Œæ³¨æ„é€™è£¡è¦æœ‰ <form> é–‹é ­ -->
<form id="hiddenGoogleForm"
  action="https://docs.google.com/forms/d/e/1FAIpQLSdawbFD-iM0l6mwpxNK7v-9OEydlhFDHUl_oDBplLbrFnKD3g/formResponse"
  method="POST"
  target="hidden_iframe"
  style="display:none;">
  <input type="text" name="entry.2070893556" id="hiddenName" />
  <input type="text" name="entry.490872160" id="hiddenResult" />
</form>
</form>
<body>
  <header>
    <h1>â™¡â™¡å®¤å…§ç©ºé–“åå¥½é¸æ“‡ç³»çµ±â™¡â™¡</h1>
  </header>
  <div id="login-container" style="text-align: center;">
    <p>è«‹è¼¸å…¥æš±ç¨±é€²å…¥</p>
    <p>è«‹å‹™å¿…è¼¸å…¥èˆ‡ä¸Šä¸€å€‹ç³»çµ±ç›¸åŒçš„æš±ç¨±ï¼Œä»¥åˆ©è³‡è¨Šçš„æ ¸å°ï¼Œéå¸¸æ„Ÿè¬æ‚¨çš„é…åˆ~</p>
    <input type="text" id="name-input" placeholder="è¼¸å…¥æš±ç¨±"><br><br> 
    <button onclick="startTest()">ç¢ºèª</button>
    <p id="error-message" style="color:red;"></p>
  </div>
  <!-- <div id="login-container" style="text-align: center;">
    <p>è«‹è¼¸å…¥å¯†ç¢¼èˆ‡æš±ç¨±ä»¥é€²å…¥(éº»ç…©æš±ç¨±åˆ°æ™‚å€™ä½¿ç”¨å¦å¤–ä¸€å€‹ç³»çµ±èˆ‡å¡«å¯«è¡¨å–®æ™‚è¦çµ±ä¸€å”·~æ„Ÿè¬æ‚¨)ï¼š</p>
    <input type="password" id="password-input" placeholder="è¼¸å…¥å¯†ç¢¼" /><br><br>
    <input type="text" id="name-input" placeholder="è¼¸å…¥æš±ç¨±" /><br><br>
    <button onclick="checkPassword()">ç¢ºèª</button>
    <p id="error-message" style="color:red;"></p>
  </div> -->

  <div id="selector-container" style="display:none;">
    <h1 style="text-align: center;">è«‹é¸æ“‡ä¸€å¼µä½ æœ€å–œæ­¡çš„<br><span style="font-size: 18px;">ğŸ“Œ è«‹ç­‰æ‰€æœ‰åœ–ç‰‡çš†è¼‰å…¥å®Œæˆå¾Œï¼Œå†é€²è¡Œé¸æ“‡ã€‚</span></h1>
  </div>
  <div id="result-container">
    <div id="result"></div>
  </div>

  <script>
  // å¾ç¶²å€æŠ“å– nicknameï¼ˆå¦‚æœæœ‰ï¼‰
function getNicknameFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("nickname") || "";
}

let userName = '';

window.addEventListener("DOMContentLoaded", () => {
  const fromURL = getNicknameFromURL();
  if (fromURL) {
    document.getElementById('name-input').value = fromURL;
  }
});

function startTest() {
  let name = document.getElementById('name-input').value.trim();
  document.querySelector('header').style.display = 'none'; // 
  const error = document.getElementById('error-message');

  if (!name) {
    name = getNicknameFromURL();
    if (!name) {
      error.textContent = 'è«‹è¼¸å…¥æš±ç¨±';
      return;
    }
    document.getElementById('name-input').value = name;
  }

  // å­˜èµ·ä¾†çµ¦å¾Œé¢é€è¡¨å–®ã€è·³ä¸‹ä¸€ä»½å•å·ç”¨
  userName = name;

  // --------- é€™è£¡åŠ ï¼šæŠŠæš±ç¨±å¡åˆ°ç¶²å€ ---------
  const newUrl = window.location.pathname + '?nickname=' + encodeURIComponent(name);
  history.replaceState(null, '', newUrl);
  // ------------------------------------------

  // éš±è—è¼¸å…¥å€ã€é¡¯ç¤ºé¸åœ–å€
  document.getElementById('login-container').style.display  = 'none';
  document.getElementById('selector-container').style.display = 'block';

  renderOptions(0);
}
//  let userName = '';

// function checkPassword() {
//   const password = document.getElementById('password-input').value.trim();
//   const name = document.getElementById('name-input').value.trim();
//   const error = document.getElementById('error-message');
//   const correctPassword = '1qaz2wsx';

//   if (password === correctPassword && name !== '') {
//     userName = name;
//     document.getElementById('login-container').style.display = 'none';
//     document.getElementById('selector-container').style.display = 'block';
//     renderOptions(0);
//   } else {
//     error.textContent = 'å¯†ç¢¼éŒ¯èª¤æˆ–æš±ç¨±æœªå¡«å¯«ï¼Œè«‹é‡æ–°è¼¸å…¥';
//   }
// }

const options = {
  layout: [
    { zh: 'å¯†é›†', en: 'dense' },
    { zh: 'æ¨™æº–', en: 'standard' },
    { zh: 'åˆ†æ•£', en: 'loose' }
  ],
  atmosphere: [
    { zh: 'è£é£¾è¤‡é›œ', en: 'ornate' },
    { zh: 'è£é£¾ç°¡å–®', en: 'plain' },
    { zh: 'å¼§åº¦', en: 'arc-min' },
    { zh: 'ç·šæ¢æ–¹æ­£', en: 'rect' },
    { zh: 'ç„¡æ˜é¡¯è¼ªå»“', en: 'blur' }
  ],
  colorDesc: [
    { zh: 'å†·ç¡¬ Ã— å–®ä¸€è‰²', en: 'hard_mono' },
    { zh: 'å†·ç¡¬ Ã— é›™è‰²', en: 'hard_duo' },
    { zh: 'å†·ç¡¬ Ã— ä½å°æ¯”å¤šè‰²', en: 'hard_lowmulti' },
    { zh: 'å†·ç¡¬ Ã— é«˜å°æ¯”å¤šè‰²', en: 'hard_highmulti' },
    { zh: 'ä¸­å’Œ Ã— å–®ä¸€è‰²', en: 'neutral_mono' },
    { zh: 'ä¸­å’Œ Ã— é›™è‰²', en: 'neutral_duo' },
    { zh: 'ä¸­å’Œ Ã— ä½å°æ¯”å¤šè‰²', en: 'neutral_lowmulti' },
    { zh: 'ä¸­å’Œ Ã— é«˜å°æ¯”å¤šè‰²', en: 'neutral_highmulti' },
    { zh: 'æŸ”å’Œ Ã— å–®ä¸€è‰²', en: 'soft_mono' },
    { zh: 'æŸ”å’Œ Ã— é›™è‰²', en: 'soft_duo' },
    { zh: 'æŸ”å’Œ Ã— ä½å°æ¯”å¤šè‰²', en: 'soft_lowmulti' },
    { zh: 'æŸ”å’Œ Ã— é«˜å°æ¯”å¤šè‰²', en: 'soft_highmulti' }
  ],
  contrast: [
    { zh: 'æ˜äº®åº¦é«˜é£½å’Œåº¦é«˜', en: 'hb-hs' },
    { zh: 'æ˜äº®åº¦é«˜é£½å’Œåº¦ä½', en: 'hb-ls' },
    { zh: 'æ˜äº®åº¦ä½é£½å’Œåº¦é«˜', en: 'lb-hs' },
    { zh: 'æ˜äº®åº¦ä½é£½å’Œåº¦ä½', en: 'lb-ls' }
  ]
};

const keys = ['layout', 'atmosphere', 'colorDesc', 'contrast'];
const selections = [];
let currentStep = 0;

function renderOptions(level) {
  const container = document.getElementById('selector-container');
  container.innerHTML = '';
  document.getElementById('result').innerHTML = '';

  // ğŸ”½ æ’å…¥æç¤ºå€å¡Š
  const titleWrapper = document.createElement('div');
  titleWrapper.style.textAlign = 'center';
  titleWrapper.style.marginBottom = '16px';

  const mainTitle = document.createElement('h2');
  mainTitle.textContent = 'è«‹é¸æ“‡ä¸€å¼µä½ æœ€å–œæ­¡çš„';
  mainTitle.style.fontSize = '30px';
  mainTitle.style.fontWeight = 'bold';
  mainTitle.style.marginBottom = '8px';
  titleWrapper.appendChild(mainTitle);

  const hint = document.createElement('p');
  hint.innerHTML = 'ğŸ“Œ <span>è«‹ç­‰æ‰€æœ‰åœ–ç‰‡çš†è¼‰å…¥å®Œæˆå¾Œï¼Œå†é€²è¡Œé¸æ“‡ã€‚</span>';
  hint.style.fontSize = '16px';
  hint.style.margin = '0';
  titleWrapper.appendChild(hint);

  container.appendChild(titleWrapper);

  const layerKey = keys[level];
  const layerOptions = options[layerKey];

  const div = document.createElement('div');
  div.className = 'layer';
  const optionContainer = document.createElement('div');
  optionContainer.className = 'options';

  if (layerOptions.length === 12) optionContainer.classList.add('grid-4');
  else if (layerOptions.length === 6) optionContainer.classList.add('grid-3');
  else if (layerOptions.length === 4) optionContainer.classList.add('grid-2');
  else optionContainer.classList.add('grid-3');

  layerOptions.forEach(opt => {
    const item = document.createElement('div');
    item.className = 'option-item';

    const label = document.createElement('div');
    label.className = 'option-label';
    label.textContent = opt.zh;

    const img = document.createElement('img');
    let filename = '';

    if (level === 1) {
      filename = `${selections[0].en}_${opt.en}.png`;
    } else if (level === 2) {
      const [desc, color] = opt.en.split('_');
      filename = `${selections[0].en}_${selections[1].en}_${color}_${desc}.png`;
    } else if (level === 3) {
      const layout = selections[0].en;
      const atmosphere = selections[1].en;
      const [desc, color] = selections[2].en.split('_');
      filename = `${layout}_${atmosphere}_${color}_${desc}_${opt.en}.png`;
    } else {
      filename = `${opt.en}.png`;
    }

    img.src = `pic/${filename}`;
    img.alt = filename;
    img.onerror = function () {
      this.style.opacity = 0.3;
      this.alt = 'æ‰¾ä¸åˆ°åœ–ç‰‡';
    };

    img.addEventListener('mouseenter', () => {
      const overlay = document.createElement('div');
      overlay.classList.add('img-overlay');
      overlay.id = 'hover-overlay';

      const popup = img.cloneNode(true);
      popup.classList.add('img-popup');
      popup.id = 'hover-popup';

      document.body.appendChild(overlay);
      document.body.appendChild(popup);
    });

    img.addEventListener('mouseleave', () => {
      const popup = document.getElementById('hover-popup');
      const overlay = document.getElementById('hover-overlay');
      if (popup) popup.remove();
      if (overlay) overlay.remove();
    });

    const button = document.createElement('button');
    button.textContent = 'é¸é€™å€‹ï¼';
    button.className = 'back-button';
    button.addEventListener('click', () => {
      const popup = document.getElementById('hover-popup');
      const overlay = document.getElementById('hover-overlay');
      if (popup) popup.remove();
      if (overlay) overlay.remove();

      selections[level] = { zh: opt.zh, en: opt.en };
      currentStep = level + 1;

      if (level === 3) {
        const layout = selections[0].en;
        const atmosphere = selections[1].en;
        const [desc, color] = selections[2].en.split('_');
        const contrast = selections[3].en;
        const finalName = `${layout}_${atmosphere}_${color}_${desc}_${contrast}.png`;
        const zhName = selections.map(s => s.zh).join('ã€');
        showResult(finalName, zhName);
        submitToGoogleForm(userName, zhName);
      } else {
        renderOptions(currentStep);
      }
    });

    item.appendChild(img);
    // item.appendChild(label);
    item.appendChild(button);
    optionContainer.appendChild(item);
  });

  div.appendChild(optionContainer);

  if (level > 0) {
    const backBtn = document.createElement('button');
    backBtn.textContent = 'â† ä¸Šä¸€å±¤';
    backBtn.className = 'back-button';
    backBtn.addEventListener('click', () => {
      selections.pop();
      currentStep = level - 1;
      renderOptions(currentStep);
    });
    container.appendChild(backBtn);
  }

  container.appendChild(div);
}

function showResult(filename, zhName) {
  const container = document.getElementById('selector-container');
  container.innerHTML = '';

  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = `
  <p style="font-weight: bold; font-size: 18px;">æ„Ÿè¬ä½ çš„é¸æ“‡ï¼Œä»¥ä¸‹æ˜¯ä½ çš„é¢¨æ ¼åœ–ç‰‡ï¼Œå»ºè­°æ‚¨æˆªåœ–ä¿å­˜å”·~</p>
  <p style="font-size: 16px;">
  è«‹å¹«å¿™å¡«å¯«æ­¤ç³»çµ±å•å·ï¼Œé»æ“Šé€™è£¡ï¼š
  <a href="#" onclick="goToBQuestionnaire()">å¡«å¯«å•å·</a>
      ï¼Œéå¸¸æ„Ÿè¬ï¼
</p>
  <img src="pic/${filename}" alt="é¢¨æ ¼åœ–ç‰‡" class="preview" onerror="this.alt='æ‰¾ä¸åˆ°åœ–ç‰‡';">
`;

//   const backBtn = document.createElement('button');
//   backBtn.textContent = 'â† ä¸Šä¸€å±¤';
//   backBtn.className = 'back-button';
//   backBtn.addEventListener('click', () => {
//     renderOptions(3);
//   });
//   container.appendChild(backBtn);
}

function submitToGoogleForm(name, selectionString) {
  const formURL = 'https://docs.google.com/forms/d/e/1FAIpQLSdawbFD-iM0l6mwpxNK7v-9OEydlhFDHUl_oDBplLbrFnKD3g/formResponse';
  const formData = new FormData();
  formData.append('entry.2070893556', name);              // æš±ç¨±
  formData.append('entry.490872160', selectionString);   // çµæœ

  fetch(formURL, {
    method: 'POST',
    mode: 'no-cors',
    body: formData
  }).then(() => {
    console.log('âœ… è¡¨å–®é€å‡ºæˆåŠŸ');
  }).catch(err => {
    console.error('âŒ è¡¨å–®é€å‡ºå¤±æ•—', err);
  });
}
//æ”¾å•å·
function goToBQuestionnaire() {
  const nickname = userName || getNicknameFromURL();
  console.log("âœ… goToBQuestionnaire å–å¾—æš±ç¨±ï¼š", nickname);  // â¬…ï¸ æ–°å¢
  const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSd35pdTTariboeeKAuMvM6FJuto5a7AaOUj_rgiy1TUoKSzUw/viewform?usp=pp_url&entry.258648634=" + encodeURIComponent(nickname);
  window.location.href = formUrl;
}

// window.addEventListener("DOMContentLoaded", () => {
//   userName = getNicknameFromURL(); // ç›´æ¥å¾ç¶²å€å–å¾— nickname
//   document.getElementById('selector-container').style.display = 'block';
//   renderOptions(0);
// });
</script>
</body>
</html>
